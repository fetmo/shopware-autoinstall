// {namespace name=backend/viison_pickware_erp_order_document_mailer/main}
Ext.define("Shopware.apps.ViisonPickwareERPOrderDocumentMailer.controller.Detail",{ override:"Shopware.apps.Order.controller.Detail",init:function(){ this.callParent(arguments);this.control({ "order-document-list":{ sendDocument:this.onSendDocument}})},onSendDocument:function(i,e){ var d=i.up("order-detail-window").record;var l=e.getDocType().first();i.up("order-detail-window").setLoading(true);Ext.Ajax.request({ method:"POST",url:'{url controller=ViisonPickwareERPOrderDocumentMailer action=getMail}',params:{ documentId:e.getId()},scope:this,callback:function(I,t,o){ i.up("order-detail-window").setLoading(false);var S=Ext.JSON.decode(o.responseText,true);if(!S||!S.success||!S.mail){ Shopware.Notification.createGrowlMessage('{s name=notification/get_mail_template/failure/title}{/s}','{s name=notification/get_mail_template/failure/message}{/s}',"Pickware");return}var a=this.onSendMail.bind(this);Ext.create("Shopware.apps.ViisonCommonMailComposer.view.Window",{ mail:S.mail,sendMail:function(){ a(this,d,e,l)}}).show()}})},onSendMail:function(i,e,d,l){ i.setLoading(true);Ext.Ajax.request({ method:"POST",url:'{url controller=ViisonPickwareERPOrderDocumentMailer action=send}',jsonData:{ mail:i.formData,documentId:d.getId()},callback:function(I,t,o){ i.setLoading(false);var S=Ext.JSON.decode(o.responseText,true);t=S&&S.success;if(t){ i.close()}var a=t?'{s name=notification/send_mail/success/title}{/s}':'{s name=notification/send_mail/failure/title}{/s}';var W=t?'{s name=notification/send_mail/success/message}{/s}':'{s name=notification/send_mail/failure/message}{/s}';var s=l.get("name")+" "+d.get("documentId");W=Ext.String.format(W,s,e.get("number"),i.formData.toAddress);Shopware.Notification.createGrowlMessage(a,W,"Pickware")}})}});
