// {namespace name=backend/viison_pickware_erp_article_profit_margin/main}
Ext.define("Shopware.apps.ViisonPickwareERPArticleProfitMargin.view.detail.Prices",{ override:"Shopware.apps.Article.view.detail.Prices",initComponent:function(){ this.currentPurchasePrice=0;this.subApp.articleWindow.on("viisonPurchasePriceChanged",this.refreshPurchasePriceAndView,this);this.subApp.articleWindow.on("articleTaxChanged",this.onArticleTaxChanged,this);this.on("beforedestroy",function(){ this.subApp.articleWindow.un("viisonPurchasePriceChanged",this.refreshPurchasePriceAndView,this);this.subApp.articleWindow.un("articleTaxChanged",this.onArticleTaxChanged,this)},this);this.callParent(arguments)},onStoresLoaded:function(e,i){ this.taxStore=i.taxes;this.mainArticle=e;this.callParent(arguments)},refreshPurchasePriceAndView:function(e,i){ this.currentPurchasePrice=i;this.calculateMargins()},onArticleTaxChanged:function(e,i){ this.subApp.selectedTaxRate=i?i.get("tax"):0;this.calculateMargins()},createElements:function(){ var e=this.callParent(arguments);this.subApp.articleWindow.fireEvent("didCreateElements",this);if(typeof this.subApp.selectedTaxRate==="undefined"){ var i=this.taxStore.findExact("id",this.mainArticle.get("taxId"));this.subApp.selectedTaxRate=i>-1?this.taxStore.getAt(i).get("tax"):0}Ext.Array.each(this.priceGrids,function(e){ Ext.Array.each(e.columns,function(i){ if(i.dataIndex==="price"){ var t=i.editor.listeners||{ };t.change=function(t,r){ var s=i.up("grid").getSelectionModel().getSelection()[0];s.set("price",r);this.updateProfitMargin(s);s.store.commitChanges();e.getView().refresh()}.bind(this);i.editor.listeners=t}else if(i.dataIndex==="viisonProfitMargin"){ var r=i.editor.listeners||{ };r.change=function(t,r){ var s=i.up("grid").getSelectionModel().getSelection()[0];s.set("viisonProfitMargin",r);this.updatePrice(s);s.store.commitChanges();e.getView().refresh()}.bind(this);i.editor.listeners=r}},this)},this);e.on("beforetabchange",function(){ this.calculateMargins()},this);return e},getColumns:function(){ var e=this.callParent(arguments);var i=-1;var t=false;Ext.Array.each(e,function(e,r){ if(e.dataIndex==="price"){ i=r}else if(e.dataIndex==="viisonProfitMargin"){ t=true;return false}return undefined});if(t){ return e}e.splice(i+1,0,{ header:'{s name=column/profitmargin/header}{/s}',tooltip:'{s name=column/profitmargin/tooltip}{/s}',dataIndex:"viisonProfitMargin",renderer:function(e,i,t){ var r=t.get("viisonProfitMargin");var s=Ext.util.Format.number(r,"0.0")+" %";if(r<=0){ return"<span style='color:red' >"+s+"</span>"}return s},editor:{ xtype:"numberfield",maxValue:99.9}});return e},calculateMargins:function(){ this.priceStore.each(function(e){ this.updateProfitMargin(e)},this);this.priceStore.commitChanges()},updateProfitMargin:function(e){ var i=e.get("price");if(this.expectsNetPriceAsInput(e)&&!ViisonPickwarePurchasePriceHelper.purchasePriceIsNet()){ i*=1+this.subApp.selectedTaxRate/100}else if(!this.expectsNetPriceAsInput(e)&&ViisonPickwarePurchasePriceHelper.purchasePriceIsNet()){ i/=1+this.subApp.selectedTaxRate/100}var t=i===0?0:100*((i-this.currentPurchasePrice)/i);e.set("viisonProfitMargin",t)},updatePrice:function(e){ var i=this.currentPurchasePrice/(1-e.get("viisonProfitMargin")/100);if(this.expectsNetPriceAsInput(e)&&!ViisonPickwarePurchasePriceHelper.purchasePriceIsNet()){ i/=1+this.subApp.selectedTaxRate/100}else if(!this.expectsNetPriceAsInput(e)&&ViisonPickwarePurchasePriceHelper.purchasePriceIsNet()){ i*=1+this.subApp.selectedTaxRate/100}e.set("price",i)},expectsNetPriceAsInput:function(e){ var i=this.customerGroupStore.findExact("key",e.get("customerGroupKey"));var t=i>-1?this.customerGroupStore.getAt(i):null;return t&&!t.get("taxInput")}});
