Ext.define("Shopware.apps.ViisonPickwareERPStockOverview.controller.Main",{ extend:"Enlight.app.Controller",refs:[{ ref:"articleGrid",selector:"viison_pickware_erp_stock_overview-list"},{ ref:"main",selector:"viison_pickware_erp_stock_overview-main"},{ ref:"orderPanel",selector:"viison_pickware_erp_stock_overview-order-list"},{ ref:"orderMain",selector:"viison_pickware_erp_stock_overview-order-main"},{ ref:"stockPlanningPanel",selector:"widget.viison_pickware_erp_stock_overview-planning_interval"}],init:function(){ this.initSalesFilterDateRange();this.control({ "viison_pickware_erp_stock_overview-list":{ openArticle:this.onOpenArticle,editRow:this.onEditRow,showOrders:this.onShowOrders,saveRecord:this.onSaveRecord},"viison_pickware_erp_stock_overview-order-list":{ openOrder:this.onOpenOrder},"viison_pickware_erp_stock_overview-planning_interval":{ planningRange:this.onChangePlanningRange}});this.getStore("Stock").on("beforeload",function(){ this.getStore("Orders").extraParams={ };this.getStore("Orders").removeAll();if(this.getOrderMain()){ this.getOrderMain().hideStats()}},this);this.mainWindow=this.getView("Main").create({ store:this.getStore("Stock"),salesStore:this.getStore("Sales"),orderStore:this.getStore("Orders")}).show();var e=this.getOrderMain().getSalesChart();var t=this.getStore("Sales");e.updateInterval(t.planningFrom,t.planningTo)},initSalesFilterDateRange:function(){ var e=this.beginOfYesterdayOneMonthAgo();var t=this.endOfYesterday();var r=this.getStore("Sales");r.planningFrom=e;r.planningTo=t;var a=this.getStore("Stock");a.getProxy().extraParams.planningFrom=e;a.getProxy().extraParams.planningTo=t},onChangePlanningRange:function(e){ var t=e.from;var r=e.to;var a=this.getStore("Stock");a.getProxy().extraParams.planningFrom=t;a.getProxy().extraParams.planningTo=r;var i=this.getStore("Sales");i.planningFrom=t;i.planningTo=r;i.updateRange();var n=this.getOrderMain().getSalesChart();n.updateInterval(t,r);n.redraw();this.getStore("Stock").load({ scope:this,callback:function(){ this.getArticleGrid().getView().refresh()}})},onOpenArticle:function(e){ Shopware.app.Application.addSubApplication({ name:"Shopware.apps.Article",action:"detail",params:{ articleId:e.get("articleId")}})},onOpenOrder:function(e){ Shopware.app.Application.addSubApplication({ name:"Shopware.apps.Order",params:{ orderId:e.get("id"),focus:"order-position-panel"}})},onSaveRecord:function(e){ e.set("not_sent",e.get("stock")-e.get("instock"));e.save({ scope:this,callback:function(){ this.getArticleGrid().getView().refresh();this.onShowOrders(e)}})},onShowSales:function(e){ this.getOrderMain().setDisabled(false);var t=this.getStore("Sales");t.getProxy().extraParams.articleDetail=e.get("id");var r=this.getOrderMain().getSalesChart();var a=this.getOrderMain().getSalesChartContainer();a.setLoading(true);t.load({ scope:this,callback:function(){ r.redraw();a.setLoading(false)}})},onShowOrders:function(e){ this.onShowSales(e);var t=this.getOrderPanel();var r=this.getOrderMain();t.setLoading(true);var a=this.getStore("Orders");a.currentPage=1;a.getProxy().extraParams.isStockValid=e.isValidStock();a.getProxy().extraParams.articleDetail=e.get("id");a.load({ scope:this,callback:function(){ t.setLoading(false);if(!e.isValidStock()){ r.updateStats(e.get("not_sent"),e.get("open"));r.showStats()}else{ r.hideStats()}}})},ISO8601Short:"Y-m-d",endOfYesterday:function(){ var e=new Date;var t=new Date(Ext.Date.format(e,this.ISO8601Short));return Ext.Date.add(t,Ext.Date.SECOND,-1)},beginOfYesterdayOneMonthAgo:function(){ var e=new Date;var t=new Date(Ext.Date.format(e,this.ISO8601Short));return Ext.Date.add(t,Ext.Date.DAY,-30)},onEditRow:function(e){ this.getArticleGrid().rowEditing.startEdit(e,0)}});
