// {namespace name=backend/viison_pickware_erp_supplier_orders/main}
Ext.define("Shopware.apps.ViisonPickwareERPSupplierOrders.controller.Edit",{ extend:"Ext.app.Controller",init:function(){ this.control({ "viison_pickware_erp_supplier_orders-article_assignment":{ moveItemsFromLeftToRight:this.onMoveArticleDetailsFromLeftToRight,moveItemsFromLeftToRightViaDragDrop:this.onMoveArticleDetailsFromLeftToRight,moveItemsFromRightToLeft:this.onMoveArticleDetailsFromRightToLeft,moveItemsFromRightToLeftViaDragDrop:this.onMoveArticleDetailsFromRightToLeft,supplierFilterChanged:this.onSupplierFilterChanged,leftPanelSearchFieldChanged:this.onLeftPanelSearchFieldChanged,showArticleDetail:this.onShowArticleDetail,removeArticleDetail:this.onRemoveArticleDetail,assignReorderArticles:this.onAssignReorderArticles,assignUrgentReorderArticles:this.onAssignUrgentReorderArticles,changeWarehouse:this.onChangeWarehouse,createSingleOrder:this.onCreateSingleOrder,createAllOrders:this.onCreateAllOrders,reloadRightPanel:this.onReloadRightPanel,articleRowEdited:this.onArticleRowEdited,cancelEditing:this.onCancelEditing,copyOrder:this.onCopyOrder,saveOrder:this.onSaveOrder},"viison_pickware_erp_supplier_orders-edit-attachments":{ downloadAttachment:this.onDownloadAttachment,deleteAttachment:this.onDeleteAttachment,uploadAttachment:this.onUploadAttachment,attachmentUploaded:this.onAttachmentUploaded}});this.supplierStore=Ext.create("Shopware.apps.ViisonPickwareERPSupplierManagement.store.Supplier",{ pageSize:1e3});this.supplierStore.load();this.itemStatusStore=this.getStore("order.ArticleStatus");this.itemStatusStore.load();this.warehouseStore=Ext.create("Shopware.apps.ViisonPickwareERPWarehouseManagement.store.Warehouse",{ });this.warehouseStore.load();this.callParent(arguments)},createEditWindow:function(e){ var t=Ext.create("Shopware.apps.ViisonPickwareERPSupplierOrders.store.ArticleDetail",{ sorters:[{ property:"reorder",direction:"DESC"},{ property:"name"}]});if(e){ t.filters.add("orderBlacklist",Ext.create("Ext.util.Filter",{ property:"orderIdBlacklist",value:e.get("id")}))}else{ t.filters.add("notPreAssignedAsOrderArticle",Ext.create("Ext.util.Filter",{ property:"preAssignedOrderArticlesBlacklist"}))}var r=Ext.create("Shopware.apps.ViisonPickwareERPSupplierOrders.store.AssignedArticleDetail",{ });if(e){ r.filters.add("preAssignedOrderArticles",Ext.create("Ext.util.Filter",{ property:"orderArticle.orderId",value:e.get("id")}));r.on("load",function(e){ e.group("supplierId");e.sort()})}else{ r.filters.add("preAssignedOrderArticles",Ext.create("Ext.util.Filter",{ property:"orderArticle.orderId",expression:"IS NULL"}));r.on("load",function(e){ e.each(function(e){ e.applyDefaultSupplier();e.commit()});e.group("supplierId");e.sort()})}var i=e?'{s name=edit/window/title/edit}{/s} - #'+e.get("orderNumber"):'{s name=edit/window/title/add}{/s}';var o=this.getView(e?"Edit":"Create").create({ title:i,record:e,supplierStore:this.supplierStore,itemStatusStore:this.itemStatusStore,warehouseStore:this.warehouseStore,leftArticleStore:t.load(),rightArticleStore:r.load()});return o},onMoveArticleDetailsFromLeftToRight:function(e,t){ if(e.record){ Ext.each(t,function(t){ var r=e.record.getSupplier().get("id");t.set("supplierId",r);t.applySupplierWithId(r);t.commit();var i=this.createOrderArticle(t);e.record.articles().add(i);e.record.setDirty(true);i.phantom=true},this);this.updateBlacklistFilter(e.leftStore,e.rightStore,"id","articleDetail.id");e.leftStore.loadPage(e.leftStore.currentPage)}else{ Ext.each(t,function(e){ e.set("orderedQuantity",Math.max(1,e.getMissingStock()));e.applyDefaultSupplier();e.commit();e.phantom=true},this);this.syncAssignmentStore(e,'{s name=notification/error/message/assign_articles}{/s}',function(){ e.rightStore.group("supplierId");e.rightStore.sort();e.leftStore.loadPage(e.leftStore.currentPage)})}},onMoveArticleDetailsFromRightToLeft:function(e,t){ if(e.record){ var r=e.record.articles();Ext.each(t,function(e){ var t=r.findExact("articleDetailId",e.get("id"));if(t>-1){ r.removeAt(t)}});e.record.setDirty(true);this.updateBlacklistFilter(e.leftStore,e.rightStore,"id","articleDetail.id");e.leftStore.loadPage(e.leftStore.currentPage)}else{ this.syncAssignmentStore(e,'{s name=notification/error/message/unassign_articles}{/s}',function(){ e.leftStore.loadPage(e.leftStore.currentPage)})}},onSupplierFilterChanged:function(e,t){ t.getProxy().extraParams.supplierId=e?e.get("id"):null;t.loadPage(1)},onLeftPanelSearchFieldChanged:function(e,t){ t.getProxy().extraParams.query=e;t.loadPage(1)},onShowArticleDetail:function(e){ Shopware.app.Application.addSubApplication({ name:"Shopware.apps.Article",action:"detail",params:{ articleId:e.get("articleId")}})},onRemoveArticleDetail:function(e,t){ e.rightStore.remove(t);this.onMoveArticleDetailsFromRightToLeft(e,[t])},onAssignReorderArticles:function(e){ e.setLoading(true);var t=Ext.create("Shopware.apps.ViisonPickwareERPSupplierOrders.store.ArticleDetail",{ pageSize:1e4});t.filters.add("notPreAssignedAsOrderArticle",Ext.create("Ext.util.Filter",{ property:"preAssignedOrderArticlesBlacklist"}));t.getProxy().extraParams.filterReorder=1;t.getProxy().extraParams.supplierId=e.leftStore.getProxy().extraParams.supplierId;t.load({ callback:function(t){ e.setLoading(false);e.rightStore.add(t);this.onMoveArticleDetailsFromLeftToRight(e,t)},scope:this})},onAssignUrgentReorderArticles:function(e){ e.setLoading(true);var t=Ext.create("Shopware.apps.ViisonPickwareERPSupplierOrders.store.ArticleDetail",{ pageSize:1e4});t.filters.add("notPreAssignedAsOrderArticle",Ext.create("Ext.util.Filter",{ property:"preAssignedOrderArticlesBlacklist"}));t.getProxy().extraParams.filterReorder=2;t.getProxy().extraParams.supplierId=e.leftStore.getProxy().extraParams.supplierId;t.load({ callback:function(t){ e.setLoading(false);e.rightStore.add(t);this.onMoveArticleDetailsFromLeftToRight(e,t)},scope:this})},onChangeWarehouse:function(e,t){ var r=e.warehouseStore.findExact("id",e.supplierOrderDestinations[t]);Ext.create("Shopware.apps.ViisonPickwareERPSupplierOrders.view.DestinationWarehouseSelection",{ selectedWarehouse:e.warehouseStore.getAt(r),confirmHandler:function(r){ var i=r.up("window").down("viison_pickware_erp_warehouse_management-warehouse_combo_box").getSelectedRecord();e.supplierOrderDestinations[t]=i.get("id");e.rightStore.group("supplierId");r.up("window").close()}}).show()},onCreateSingleOrder:function(e,t,r){ if(!this.validateArticleDetailRecords(e,t)){ return}this.createOrder(t,r,e.supplierOrderDestinations[r]);this.syncNewOrders(e,t,'{s name=notification/error/message/create_order}{/s}',function(e,t){ this.openCreatedOrder(e,t,this)}.bind(this))},onCreateAllOrders:function(e){ var t=[];Ext.each(e.rightStore.getGroups(),function(e){ if(e.name){ t=t.concat(e.children)}});if(!this.validateArticleDetailRecords(e,t)){ return}Ext.each(e.rightStore.getGroups(),function(t){ if(t.name){ this.createOrder(t.children,t.name,e.supplierOrderDestinations[t.name])}},this);this.syncNewOrders(e,t,'{s name=notification/error/message/create_all_orders}{/s}')},onReloadRightPanel:function(e){ var t=e.rightStore.sorters.findBy(function(e){ return e.property==="supplierId"});if(t){ e.rightStore.sorters.remove(t)}e.rightStore.load()},onArticleRowEdited:function(e,t){ if(e.record){ var r=e.record.articles().findExact("articleDetailId",t.get("id"));if(r>-1){ var i=e.record.articles().getAt(r);i.set("orderedQuantity",t.get("orderedQuantity"));i.set("deliveredQuantity",t.get("deliveredQuantity"));i.set("price",t.get("price"));i.set("status",t.get("status"))}}else{ t.setDirty(true);this.syncAssignmentStore(e,'{s name=notification/error/message/edit_assigned_article}{/s}')}},onCancelEditing:function(e){ e.record.reject();e.record.articles().rejectChanges();e.record.setDirty(false);e.up("viison_pickware_erp_supplier_orders-edit").close()},onCopyOrder:function(e){ var t=[];e.rightStore.each(function(e){ t.push(e)});var r=this.createOrder(t,e.record.getSupplier().get("id"));r.set("comment",e.record.get("comment"));r.set("documentComment",e.record.get("documentComment"));var i=e.down("viison_pickware_erp_warehouse_management-warehouse_combo_box").getSelectedRecord();r.set("warehouseId",i.get("id"));r.articles().each(function(e){ e.set("deliveredQuantity",0);e.set("deliveryTime",0);e.set("status",0)});e.record.reject(true);e.up("viison_pickware_erp_supplier_orders-edit").close();this.syncNewOrders(e,[],'{s name=notification/error/message/create_order}{/s}',function(e,t){ this.openCreatedOrder(e,t,this)}.bind(this))},onSaveOrder:function(e){ var t=[];e.rightStore.each(function(e){ t.push(e)});if(!this.validateArticleDetailRecords(e,t)){ return}var r=e.down("viison_pickware_erp_warehouse_management-warehouse_combo_box").getSelectedRecord();e.record.set("warehouseId",r.get("id"));var i=e.rightPanel.nextSibling("form");i.getForm().updateRecord(e.record);e.record.setDirty(true);var o=e.up("viison_pickware_erp_supplier_orders-edit");o.setLoading(true);var a=this.getController("Main");a.syncOrders('{s name=notification/error/message/save}{/s}',function(e){ o.setLoading(false);if(e){ a.orderStore.load();o.close()}})},onDownloadAttachment:function(e){ var t='{url controller=mediaManager action=download}?mediaId='+e.get("mediaId");window.open(t,"_blank")},onDeleteAttachment:function(e,t){ e.record.attachments().remove(t);e.setDirty(true);e.setLoading(true);this.getController("Main").syncOrders('{s name=notification/error/message/delete_attachment}{/s}',function(){ e.setLoading(false)})},onUploadAttachment:function(e){ var t=e.nextSibling("html5fileupload");var r=e.getEl().down("input[type=file]").dom;t.iterateFiles(r.files)},onAttachmentUploaded:function(e,t){ var r=Ext.decode(t.responseText);if(!r.success){ Shopware.Notification.createGrowlMessage('{s name=notification/error/title}{/s}','{s name=notification/error/message/upload_attachment}{/s}',"ViisonPickwareERPSupplierOrders");return}e.record.attachments().add(Ext.create("Shopware.apps.ViisonPickwareERPSupplierOrders.model.order.Attachment",{ mediaId:r.data.id,filename:r.data.name+"."+r.data.extension,date:new Date}));e.record.setDirty(true);e.setLoading(true);this.getController("Main").syncOrders('{s name=notification/error/message/upload_attachment}{/s}',function(){ e.setLoading(false)})},validateArticleDetailRecords:function(e,t){ var r=true;Ext.each(t,function(t){ if(t.get("orderedQuantity")<=0){ r=false;var i=e.rightStore.indexOf(t);e.rowEditor.startEdit(i,0);return false}return undefined});return r},createOrder:function(e,t,r){ var i=Ext.create("Shopware.apps.ViisonPickwareERPSupplierOrders.model.Order",{ });i.setSupplier(this.supplierStore.getById(t));i.set("warehouseId",r);Ext.each(e,function(e){ var t=this.createOrderArticle(e);i.articles().add(t)},this);this.getController("Main").orderStore.add(i);return i},createOrderArticle:function(e){ var t=Ext.create("Shopware.apps.ViisonPickwareERPSupplierOrders.model.order.Article",e.raw);t.set("id",null);t.set("articleDetailId",e.get("id"));t.set("orderedQuantity",e.get("orderedQuantity"));t.set("price",e.get("price"));return t},syncNewOrders:function(e,t,r,i){ e.setLoading(true);var o=this.getController("Main").orderStore;this.getController("Main").syncOrders(r,function(r,a){ e.setLoading(false);if(r){ o.loadPage(1,{ callback:function(){ if(Ext.isFunction(i)){ i(true,a)}}});e.rightStore.remove(t);e.rightStore.sort()}else if(Ext.isFunction(i)){ i(false)}})},openCreatedOrder:function(e,t,r){ if(e&&t.length===1){ var i=r.getController("Main").orderStore.getById(t[0].get("id"));r.createEditWindow(i)}},syncAssignmentStore:function(e,t,r){ var i=e.rightStore;var o=i.getNewRecords().length+i.getModifiedRecords().length+i.getRemovedRecords().length;if(o===0){ if(Ext.isFunction(r)){ r(true)}return}e.rightPanel.setLoading(true);i.sync({ scope:this,success:function(){ e.rightPanel.setLoading(false);if(Ext.isFunction(r)){ r(true)}},failure:function(){ e.rightPanel.setLoading(false);i.rejectChanges();var o=t||"";Shopware.Notification.createGrowlMessage('{s name=notification/error/title}{/s}',o,"ViisonPickwareERPSupplierOrders");if(Ext.isFunction(r)){ r(false)}}})},updateBlacklistFilter:function(e,t,r,i){ if(t.count()>0){ var o=[];t.each(function(e){ o.push(e.get(r))});e.filters.add("blacklist",Ext.create("Ext.util.Filter",{ property:i,expression:"NOT IN",value:o}))}else{ e.filters.removeAtKey("blacklist")}}});
