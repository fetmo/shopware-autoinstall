// {namespace name=backend/viison_pickware_erp_rated_stock/main}
Ext.define("Shopware.apps.ViisonPickwareERPRatedStock.controller.Main",{ extend:"Ext.app.Controller",refs:[{ ref:"detailView",selector:"viison_pickware_erp_rated_stock-detail"},{ ref:"filterView",selector:"viison_pickware_erp_rated_stock-filter"}],init:function(){ this.control({ "viison_pickware_erp_rated_stock-filter":{ applyFilter:this.onApplyFilter,exportData:this.onExportData},"viison_pickware_erp_rated_stock-filter viison_pickware_erp_warehouse_management-warehouse_combo_box":{ warehouseChanged:this.onWarehouseChanged},"viison_pickware_erp_rated_stock-list":{ searchFieldChanged:this.onSearchFieldChanged,articleRowSelected:this.onArticleRowSelected,showArticleDetail:this.onShowArticleDetail}});this.mainWindow=this.getView("Main").create({ articleStore:this.getStore("Article"),stockStore:this.getStore("Stock")});this.mainWindow.show();this.updateStoreFilter(this.getFilterView());this.getStore("Article").on("load",this.onMainStoreLoaded,this)},onApplyFilter:function(e){ this.updateStoreFilter(e);this.getStore("Article").loadPage(1)},onExportData:function(){ var e=this.getStore("Article").filters.get("created").value;var t=this.getStore("Article").filters.get("warehouseId").value;var i=this.getFilterView().down("checkbox[name=excludeWithoutStock]").getValue();var r='{url controller=ViisonPickwareERPRatedStock action=exportInventory}?';r+="referenceDate="+e.toISOString();r+="&warehouseId="+t;r+="&excludeWithoutStock="+i;window.open(r,"_blank")},onWarehouseChanged:function(e){ if(e){ this.getStore("Article").filters.add("warehouseId",Ext.create("Ext.util.Filter",{ property:"warehouseId",value:e.get("id")}))}else{ this.getStore("Article").filters.removeAtKey("warehouseId")}this.getStore("Article").loadPage(1)},onSearchFieldChanged:function(e){ this.getStore("Article").getProxy().extraParams.query=e;this.getStore("Article").loadPage(1)},onArticleRowSelected:function(e,t){ var i=e.up("viison_pickware_erp_rated_stock-main").down("viison_pickware_erp_warehouse_management-warehouse_combo_box").getSelectedRecord();this.selectedArticle=t;this.getDetailView().expand();this.getStore("Stock").getProxy().extraParams.articleDetailId=t.get("articleDetailId");this.getStore("Stock").getProxy().extraParams.warehouseId=i?i.get("id"):null;this.getStore("Stock").load()},onShowArticleDetail:function(e){ Shopware.app.Application.addSubApplication({ name:"Shopware.apps.Article",action:"detail",params:{ articleId:e.get("articleId")}})},onMainStoreLoaded:function(e){ this.getFilterView().updatePriceView(e.proxy.reader.rawData);this.getDetailView().collapse();this.getStore("Stock").loadData([])},updateStoreFilter:function(e){ var t=e.down("datefield[name=untilDate]").getValue();t.setTime(t.getTime()+24*60*60*1e3);this.getStore("Article").filters.add("created",Ext.create("Ext.util.Filter",{ property:"created",expression:"<",value:t}));this.getStore("Article").getProxy().extraParams.excludeWithoutStock=e.down("checkbox[name=excludeWithoutStock]").getValue()}});
