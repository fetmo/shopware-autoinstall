// {namespace name=backend/viison_pickware_erp_supplier_management/main}
Ext.define("Shopware.apps.ViisonPickwareERPSupplierManagement.controller.Edit",{ extend:"Ext.app.Controller",init:function(){ this.control({ "viison_pickware_erp_supplier_management-edit-base button[action=cancel]":{ click:this.onCancel},"viison_pickware_erp_supplier_management-edit-base button[action=save]":{ click:this.onSaveBase},"viison_pickware_erp_supplier_management-edit-article_assignment":{ moveItemsFromLeftToRight:this.onMoveItemsFromLeftToRight,moveItemsFromLeftToRightViaDragDrop:this.onMoveItemsFromLeftToRight,moveItemsFromRightToLeft:this.onMoveItemsFromRightToLeft,moveItemsFromRightToLeftViaDragDrop:this.onMoveItemsFromRightToLeft,leftPanelSearchFieldChanged:this.onSearchFieldChanged,rightPanelSearchFieldChanged:this.onSearchFieldChanged,articleRowEdited:this.onArticleRowEdited,showArticleDetail:this.onShowArticleDetail},"viison_pickware_erp_supplier_management-edit-fabricator_assignment":{ moveItemsFromLeftToRight:this.onMoveItemsFromLeftToRight,moveItemsFromLeftToRightViaDragDrop:this.onMoveItemsFromLeftToRight,moveItemsFromRightToLeft:this.onMoveItemsFromRightToLeft,moveItemsFromRightToLeftViaDragDrop:this.onMoveItemsFromRightToLeft,leftPanelSearchFieldChanged:this.onSearchFieldChanged,rightPanelSearchFieldChanged:this.onSearchFieldChanged},"viison_pickware_erp_supplier_management-edit-fabricator_assignment button[action=assignAllFabricatorArticles]":{ click:this.onAssignAllFabricatorArticles}});this.callParent(arguments)},createEditWindow:function(e){ var i=Ext.create("Shopware.apps.ViisonPickwareERPSupplierManagement.store.ArticleDetail",{ });if(e.get("id")){ i.filters.add("supplierBlacklist",Ext.create("Ext.util.Filter",{ property:"supplierIdBlacklist",expression:"!=",value:e.get("id")}))}var t=Ext.create("Shopware.apps.ViisonPickwareERPSupplierManagement.store.AssignedArticleDetail",{ });if(e.get("id")){ t.filters.add("supplierId",Ext.create("Ext.util.Filter",{ property:"supplierArticleDetail.supplierId",value:e.get("id")}))}var a=Ext.create("Shopware.apps.ViisonPickwareERPSupplierManagement.store.Fabricator",{ });if(e.get("id")){ a.filters.add("supplierBlacklist",Ext.create("Ext.util.Filter",{ property:"supplierIdBlacklist",expression:"!=",value:e.get("id")}))}var r=Ext.create("Shopware.apps.ViisonPickwareERPSupplierManagement.store.AssignedFabricator",{ });if(e.get("id")){ r.filters.add("supplierId",Ext.create("Ext.util.Filter",{ property:"supplierFabricator.supplierId",value:e.get("id")}))}var o=e.get("name").length>0?'{s name=edit/window/title/edit}{/s} - '+e.get("name"):'{s name=edit/window/title/add}{/s}';var n=this.getView("Edit").create({ title:o,record:e,languageStore:this.getLanguageStore(),leftArticleStore:i.load(),rightArticleStore:t.load(),leftFabricatorStore:a.load(),rightFabricatorStore:r.load()});return n},onCancel:function(e){ e.up("viison_pickware_erp_supplier_management-edit").close()},onSaveBase:function(e){ var i=e.up("viison_pickware_erp_supplier_management-edit-base");if(!i.getForm().isValid()){ return}if(i.record.phantom){ this.getController("Main").supplierStore.add(i.record)}i.getForm().updateRecord(i.record);this.getController("Main").syncSuppliers('{s name=notification/error/message/save}{/s}',function(i){ if(i){ e.up("viison_pickware_erp_supplier_management-edit").close()}})},onArticleRowEdited:function(e,i){ i.setDirty();this.syncAssignmentStore(e)},onShowArticleDetail:function(e){ Shopware.app.Application.addSubApplication({ name:"Shopware.apps.Article",action:"detail",params:{ articleId:e.get("articleId")}})},onMoveItemsFromLeftToRight:function(e,i){ Ext.each(i,function(i){ i.set("supplierId",e.record.get("id"));i.commit();i.phantom=true});this.syncAssignmentStore(e,function(){ e.leftStore.loadPage(e.leftStore.currentPage);e.rightStore.loadPage(e.rightStore.currentPage)})},onMoveItemsFromRightToLeft:function(e){ this.syncAssignmentStore(e,function(){ e.leftStore.loadPage(e.leftStore.currentPage);e.rightStore.loadPage(e.rightStore.currentPage)})},onSearchFieldChanged:function(e,i){ i.getProxy().extraParams.query=e;i.loadPage(1)},onAssignAllFabricatorArticles:function(e){ var i=e.up("viison_pickware_erp_supplier_management-edit-fabricator_assignment").record;var t=e.up("viison_pickware_erp_supplier_management-edit").down("viison_pickware_erp_supplier_management-edit-fabricator_assignment");var a=e.up("viison_pickware_erp_supplier_management-edit").down("viison_pickware_erp_supplier_management-edit-article_assignment");t.setLoading(true);Ext.Ajax.request({ url:'{url controller=ViisonPickwareERPSupplierManagement action=assignFabricatorArticles}',params:{ id:i.get("id")},success:function(){ t.setLoading(false);a.leftStore.loadPage(1);a.rightStore.loadPage(1)},failure:function(){ t.setLoading(false);Shopware.Notification.createGrowlMessage('{s name=notification/error/title}{/s}','{s name=notification/error/message/save_all_fabricator_article_mappings}{/s}',"ViisonPickwareERPSupplierManagement")},scope:this})},syncAssignmentStore:function(e,i){ var t=e.rightStore;var a=t.getNewRecords().length+t.getModifiedRecords().length+t.getRemovedRecords().length;if(a===0){ if(Ext.isFunction(i)){ i(true)}return}e.rightPanel.setLoading(true);t.sync({ scope:this,success:function(){ e.rightPanel.setLoading(false);if(Ext.isFunction(i)){ i(true)}},failure:function(){ e.rightPanel.setLoading(false);t.rejectChanges();var a="";if(t.model.modelName==="Shopware.apps.ViisonPickwareERPSupplierManagement.model.ArticleDetail"){ a='{s name=notification/error/message/save_article_mappings}{/s}'}else if(t.model.modelName==="Shopware.apps.ViisonPickwareERPSupplierManagement.model.Fabricator"){ a='{s name=notification/error/message/save_fabricator_mappings}{/s}'}Shopware.Notification.createGrowlMessage('{s name=notification/error/title}{/s}',a,"ViisonPickwareERPSupplierManagement");if(Ext.isFunction(i)){ i(false)}}})},getLanguageStore:function(){ if(!this.languageStore){ this.languageStore=Ext.create("Shopware.apps.ViisonPickwareERPSupplierManagement.store.SupplierLanguage");this.languageStore.load()}return this.languageStore}});
