Ext.define("Shopware.apps.ViisonPickwareERPWarehouseManagement.controller.Edit",{ extend:"Ext.app.Controller",mixins:["Shopware.apps.ViisonCommonApp.Mixin"],viisonSnippetNamespace:"backend/viison_pickware_erp_warehouse_management/main",estimatedNumberOfPossibleBinLocations:0,init:function(){ this.control({ "viison_pickware_erp_warehouse_management-edit-base button[action=cancel]":{ click:this.onCancel},"viison_pickware_erp_warehouse_management-edit-base button[action=save]":{ click:this.onSaveBase},"viison_pickware_erp_warehouse_management-edit-bin_locations":{ searchFieldChanged:this.onBinLocationSearchFieldChanged},"viison_pickware_erp_warehouse_management-edit-bin_locations button[action=addBinLocation]":{ click:this.onAddBinLocation},"viison_pickware_erp_warehouse_management-edit-bin_locations button[action=generateBinLocations]":{ click:this.onGenerateBinLocations},"viison_pickware_erp_warehouse_management-edit-bin_locations button[action=deleteSelectedBinLocations]":{ click:this.onDeleteSelectedBinLocations},"viison_pickware_erp_warehouse_management-edit-bin_locations-bin_location_list":{ binLocationSelectionChanged:this.onBinLocationSelectionChanged,saveBinLocation:this.onSaveBinLocation,deleteBinLocation:this.onDeleteBinLocation},"viison_pickware_erp_warehouse_management-edit-bin_locations-article_detail_mapping_list":{ showArticle:this.onShowArticle}});this.callParent(arguments)},createEditWindow:function(e){ var i=e.get("name").length>0?this.getViisonSnippet("edit/window/title/edit")+" - "+e.get("name"):this.getViisonSnippet("edit/window/title/add");var t=this.getView("Edit").create({ title:i,record:e});return t},onCancel:function(e){ e.up("viison_pickware_erp_warehouse_management-edit").close()},onSaveBase:function(e){ var i=e.up("viison_pickware_erp_warehouse_management-edit-base");if(!i.getForm().isValid()){ return}i.getForm().updateRecord(i.record);i.record.set("stockAvailable",i.getForm().getFieldValues().stockAvailable);i.record.set("defaultWarehouse",i.getForm().getFieldValues().defaultWarehouse);if(i.record.phantom){ this.getController("Main").warehouseStore.add(i.record)}var t=this.getController("Main").warehouseStore;this.getController("Main").syncWarehouses(this.getViisonSnippet("notification/error/message/save"),function(n,o){ if(n){ e.up("viison_pickware_erp_warehouse_management-edit").close();if(i.record.get("defaultWarehouse")){ t.each(function(e){ if(e.get("id")!==i.record.get("id")){ e.set("defaultWarehouse",false);e.modified={ }}})}}else if(o.uniqueConstraintViolation){ Shopware.Notification.createGrowlMessage(this.getViisonSnippet("notification/error/title"),this.getViisonSnippet("notification/error/message/save/unique_constraint_violation"),"ViisonPickwareERPWarehouseManagement")}})},onBinLocationSearchFieldChanged:function(e,i){ var t=e.down("viison_pickware_erp_warehouse_management-edit-bin_locations-bin_location_list").store;t.getProxy().extraParams.query=i;t.loadPage(1)},onAddBinLocation:function(e){ var i=e.up("viison_pickware_erp_warehouse_management-edit-bin_locations");var t=i.down("viison_pickware_erp_warehouse_management-edit-bin_locations-bin_location_list");this.getController("BinLocationCreation").createWindow(i.record,t.store)},onGenerateBinLocations:function(e){ var i=e.up("viison_pickware_erp_warehouse_management-edit-bin_locations");this.getController("BinLocationGenerator").createWindow(i.record)},onDeleteSelectedBinLocations:function(e){ var i=e.up("viison_pickware_erp_warehouse_management-edit-bin_locations").down("viison_pickware_erp_warehouse_management-edit-bin_locations-bin_location_list");Ext.Msg.confirm(this.getViisonSnippet("alert/title"),this.getViisonSnippet("alert/message/delete_selected_bin_locations")+" "+this.getViisonSnippet("alert/message/delete_bin_location/info"),function(e){ if(e!=="yes"){ return}var t=i.selModel.getSelection();i.store.remove(t);this.syncBinLocations(i,this.getViisonSnippet("notification/error/message/delete_selected_bin_locations"))},this)},onBinLocationSelectionChanged:function(e,i){ var t=e.up("viison_pickware_erp_warehouse_management-edit-bin_locations");var n=t.down("viison_pickware_erp_warehouse_management-edit-bin_locations-article_detail_mapping_list");n.store.clearFilter(true);if(i.length===1){ n.setDisabled(false);n.store.filter([{ property:"binLocationArticleDetail.binLocationId",value:i[0].get("id")}])}else{ n.setDisabled(true);n.store.removeAll()}t.down("button[action=deleteSelectedBinLocations]").setDisabled(i.length===0)},onSaveBinLocation:function(e,i){ var t=i.get("code");var n=e.up("viison_pickware_erp_warehouse_management-edit-bin_locations");n.setLoading(true);e.store.sync({ scope:this,success:function(){ n.setLoading(false)},failure:function(i){ n.setLoading(false);e.store.rejectChanges();var o=this.getViisonSnippet("notification/error/message/save_bin_location");if(i.proxy.reader.jsonData&&i.proxy.reader.jsonData.uniqueConstraintViolation){ o=Ext.String.format(this.getViisonSnippet("notification/error/message/save_bin_location/unique_constraint_violation"),n.record.get("displayName"),t)}Shopware.Notification.createGrowlMessage(this.getViisonSnippet("notification/error/title"),o,"ViisonPickwareERPWarehouseManagement")}})},onDeleteBinLocation:function(e,i){ Ext.Msg.confirm("Achtung",Ext.String.format(this.getViisonSnippet("alert/message/delete_bin_location")+" "+this.getViisonSnippet("alert/message/delete_bin_location/info"),i.get("code")),function(t){ if(t!=="yes"){ return}e.store.remove(i);this.syncBinLocations(e,this.getViisonSnippet("notification/error/message/delete_bin_location"))},this)},onShowArticle:function(e,i){ Shopware.app.Application.addSubApplication({ name:"Shopware.apps.Article",action:"detail",params:{ articleId:i.get("articleId")}})},syncBinLocations:function(e,i,t){ var n=e.store.getNewRecords().length+e.store.getModifiedRecords().length+e.store.getRemovedRecords().length;if(n===0){ if(Ext.isFunction(t)){ t(true)}return}e.selModel.deselectAll();e.setLoading(true);e.store.sync({ scope:this,success:function(){ e.setLoading(false);if(Ext.isFunction(t)){ t(true)}},failure:function(n){ e.setLoading(false);e.store.rejectChanges();var o=i||"";Shopware.Notification.createGrowlMessage(this.getViisonSnippet("notification/error/title"),o,"ViisonPickwareERPWarehouseManagement");if(Ext.isFunction(t)){ t(false,n.proxy.reader.jsonData)}}})}});
