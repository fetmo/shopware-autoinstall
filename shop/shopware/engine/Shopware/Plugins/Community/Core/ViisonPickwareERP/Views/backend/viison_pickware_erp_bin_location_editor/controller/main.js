// {namespace name=backend/viison_pickware_erp_bin_location_editor/main}
Ext.define("Shopware.apps.ViisonPickwareERPBinLocationEditor.controller.Main",{ extend:"Ext.app.Controller",snippets:{ notification:{ binLocationChanged:{ success:{ title:'{s name=notification/bin_location_changed/success/title}{/s}',message:'{s name=notification/bin_location_changed/success/message}{/s}'},failure:{ title:'{s name=notification/bin_location_changed/failure/title}{/s}',message:'{s name=notification/bin_location_changed/failure/message}{/s}'},dataOutdated:{ title:'{s name=notification/bin_location_changed/data_outdated/title}{/s}',message:'{s name=notification/bin_location_changed/data_outdated/message}{/s}'}},physicalStockChanged:{ success:{ title:'{s name=notification/physical_stock_changed/success/title}{/s}',message:'{s name=notification/physical_stock_changed/success/message}{/s}'},failure:{ title:'{s name=notification/physical_stock_changed/failure/title}{/s}',message:'{s name=notification/physical_stock_changed/failure/message}{/s}'}}}},init:function(){ this.control({ "viison_pickware_erp_bin_location_editor-main-panel":{ cancel:this.onCancel,save:this.onSave},"viison_pickware_erp_bin_location_editor-main-panel viison_pickware_erp_bin_location_editor-main-bin_location_field":{ editBinLocation:this.onEditBinLocation},"viison_pickware_erp_bin_location_editor-bin_location_creation-panel button[action=save]":{ click:this.onSaveNewBinLocation},"viison_pickware_erp_bin_location_editor-bin_location_creation-panel button[action=cancel]":{ click:this.onCancelCreation},"viison_pickware_erp_bin_location_editor-bin_location_selection button[action=cancel]":{ click:this.onCancelSelection},"viison_pickware_erp_bin_location_editor-bin_location_selection-panel":{ addBinLocation:this.onAddBinLocation,selectBinLocation:this.onSelectBinLocation,searchFieldChanged:this.onSearchFieldChanged}});this.commentStore=Ext.create("Shopware.apps.ViisonPickwareERPBinLocationEditor.store.Comment",{ });this.commentStore.load();this.callParent(arguments)},createEditor:function(i,e,o,n){ return Ext.create("Shopware.apps.ViisonPickwareERPBinLocationEditor.view.Main",{ article:i,articleDetail:e,binLocation:o,commentStore:this.commentStore,saveCallback:n||Ext.emptyFn}).show()},onCancel:function(i){ i.up("viison_pickware_erp_bin_location_editor-main").close()},onSave:function(i){ var e=i.article;var o=i.articleDetail;var n=i.binLocation;if(!i.getForm().isValid()){ return}var a=i.getForm().getValues();i.setLoading(true);Ext.Ajax.request({ method:"POST",url:'{url controller=ViisonPickwareERPBinLocationEditor action=saveBinLocation}',params:{ articleDetailId:o.get("id"),warehouseId:n.get("warehouseId"),oldBinLocationId:n.get("binLocationId")||n.get("defaultBinLocation").id,newBinLocationId:a.binLocation?a.binLocation.id:n.get("defaultBinLocation").id,newStock:parseInt(a.stock,10),purchasePrice:a.purchasePrice||o.get("purchasePrice"),comment:a.comment},scope:this,callback:function(t,c,l){ var s=l.responseText&&Ext.JSON.decode(l.responseText,true);var d=c&&s&&s.success;i.setLoading(false);var r=t.params;var S='"'+e.get("name")+'" ('+o.get("number")+")";if(r.oldBinLocationId!==r.newBinLocationId){ var _=n.get("binLocationCode")&&n.get("binLocationCode")!=='{$pickwareDefaultBinLocationCode}'?n.get("binLocationCode"):"-";var I=a.binLocation&&a.binLocation.code!=='{$pickwareDefaultBinLocationCode}'?a.binLocation.code:"-";var F=this.snippets.notification.binLocationChanged.success;if(!d){ F=s&&s.code==='{$errorCodeDataOutdated}'?this.snippets.notification.binLocationChanged.dataOutdated:this.snippets.notification.binLocationChanged.failure}var W=Ext.String.format(F.message,S,_,I);Shopware.Notification.createGrowlMessage(F.title,W,"Pickware")}if(r.newStock!==n.get("stock")){ var v=d?this.snippets.notification.physicalStockChanged.success:this.snippets.notification.physicalStockChanged.failure;var Y=Ext.String.format(v.message,S,n.get("stock"),r.newStock);Shopware.Notification.createGrowlMessage(v.title,Y,"Pickware")}if(!d||!l.responseText){ return}o.set("inStock",s.data.inStock);o.set("purchasePrice",r.purchasePrice);o.set("viisonPhysicalStockForSale",s.data.viisonPhysicalStockForSale);o.set("viisonReservedStock",0);n.set("stock",r.newStock);var T=a.binLocation||n.get("defaultBinLocation");n.set("binLocationId",T.id);n.set("binLocationCode",T.code);delete o.modified.inStock;delete o.modified.purchasePrice;delete o.modified.viisonPhysicalStockForSale;i.up("viison_pickware_erp_bin_location_editor-main").close();if(Ext.isFunction(i.saveCallback)){ i.saveCallback()}}})},onEditBinLocation:function(i){ var e=i.up("viison_pickware_erp_bin_location_editor-main").binLocation;var o=e.get("warehouseId");var n=Ext.create("Shopware.apps.ViisonPickwareERPWarehouseManagement.store.BinLocation",{ pageSize:20,filters:[{ property:"binLocation.warehouseId",value:o}]});n.load();var a=function(e){ i.setValue(e.getData())};Ext.create("Shopware.apps.ViisonPickwareERPBinLocationEditor.view.BinLocationSelection",{ binLocationStore:n,binLocation:e,warehouseId:o,saveCallback:a}).show()},onSaveNewBinLocation:function(i){ var e=i.up("viison_pickware_erp_bin_location_editor-bin_location_creation-panel");var o=e.up("viison_pickware_erp_bin_location_editor-bin_location_creation");var n=o.selectionWindow;if(!e.getForm().isValid()){ return}o.close();var a=e.getForm().getValues().code;var t=Ext.create("Shopware.apps.ViisonPickwareERPWarehouseManagement.model.BinLocation",{ });t.set("code",a);t.set("warehouseId",n.warehouseId);n.setLoading(true);n.binLocationStore.add(t);n.binLocationStore.sync({ callback:function(i){ n.setLoading(false);var e=i.operations[0];if(e.success){ var o=n.down("textfield[name=searchfield]");o.setValue(t.get("code"))}else{ n.binLocationStore.rejectChanges();var c=e.request.proxy.reader.jsonData.uniqueConstraintViolation;var l=c?'{s name=notification/save_new_bin_location/error/message/duplicate_location}{/s}':'{s name=notification/save_new_bin_location/error/message/unknown_error}{/s}';l=Ext.String.format(l,a);Shopware.Notification.createGrowlMessage('{s name=notification/save_new_bin_location/error/title}{/s}',l,"ViisonPickwareERP")}}})},onCancelCreation:function(i){ i.up("viison_pickware_erp_bin_location_editor-bin_location_creation").close()},onCancelSelection:function(i){ i.up("viison_pickware_erp_bin_location_editor-bin_location_selection").close()},onAddBinLocation:function(i){ Ext.create("Shopware.apps.ViisonPickwareERPBinLocationEditor.view.BinLocationCreation",{ selectionWindow:i.up("viison_pickware_erp_bin_location_editor-bin_location_selection")}).show()},onSelectBinLocation:function(i,e){ var o=i.up("viison_pickware_erp_bin_location_editor-bin_location_selection");o.close();if(Ext.isFunction(o.saveCallback)){ o.saveCallback(e)}},onSearchFieldChanged:function(i,e){ i.store.getProxy().extraParams.query=e;i.store.loadPage(1)}});
