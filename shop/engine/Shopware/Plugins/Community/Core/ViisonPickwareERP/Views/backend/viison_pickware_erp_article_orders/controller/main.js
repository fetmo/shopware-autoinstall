// {namespace name=backend/viison_pickware_erp_article_orders/main}
Ext.define("Shopware.apps.ViisonPickwareERPArticleOrders.controller.Main",{ extend:"Ext.app.Controller",refs:[{ ref:"articleOrdersList",selector:"viison_pickware_erp_article_orders-detail-article_orders_list"},{ ref:"fromField",selector:"viison_pickware_erp_article_orders-detail-article_orders_list toolbar datefield[name=from]"},{ ref:"toField",selector:"viison_pickware_erp_article_orders-detail-article_orders_list toolbar datefield[name=to]"}],init:function(){ this.control({ "viison_pickware_erp_article_orders-detail-article_orders_list viison_common_variant_combo_box-combo_box":{ variantChanged:this.onVariantChanged},"viison_pickware_erp_article_orders-detail-article_orders_list":{ showCustomer:this.onShowCustomer,showOrder:this.onShowOrder},"viison_pickware_erp_article_orders-detail-article_orders_list toolbar datefield":{ change:this.onFilterChange},"viison_pickware_erp_article_orders-detail-article_orders_list toolbar button[action=export]":{ click:this.onExportButtonClicked}});this.ordersStore=Ext.create("Shopware.apps.ViisonPickwareERPArticleOrders.store.ArticleOrder",{ });this.callParent(arguments)},createArticleOrdersTab:function(){ var e=Ext.create("Shopware.apps.ViisonPickwareERPArticleOrders.view.detail.ArticleOrdersList",{ store:this.ordersStore});this.subApplication.on("ProductModule:storesChanged",this.articleChanged,e);var r=e.down("viison_common_variant_combo_box-combo_box");r.setArticle(this.article);return e},onVariantChanged:function(e){ this.selectedVariant=e;this.loadOrders()},onFilterChange:function(){ this.loadOrders()},onExportButtonClicked:function(){ var e='{url controller=ViisonPickwareERPArticleOrders action=exportArticleOrdersList}?';e+="filter="+Ext.JSON.encode(this.ordersStore.filters.items.map(function(e){ return{ property:e.property,value:e.value,expression:e.expression?e.expression:null,operator:e.operator?e.operator:null}}));window.open(e,"_blank")},onShowCustomer:function(e){ Shopware.app.Application.addSubApplication({ name:"Shopware.apps.Customer",action:"detail",params:{ customerId:e.get("userId")}})},onShowOrder:function(e){ Shopware.app.Application.addSubApplication({ name:"Shopware.apps.Order",action:"detail",params:{ orderId:e.get("orderId")}})},setArticle:function(e){ this.article=e;this.ordersStore.filters.add("articleId",Ext.create("Ext.util.Filter",{ property:"orderDetail.articleId",value:this.article.get("id")}))},loadOrders:function(){ if(this.selectedVariant){ this.ordersStore.filters.add("articleNumber",Ext.create("Ext.util.Filter",{ property:"orderDetail.articleNumber",value:this.selectedVariant.get("number")}))}else{ this.ordersStore.filters.removeAtKey("articleNumber")}if(this.getFromField().getValue()){ this.ordersStore.filters.add("from",Ext.create("Ext.util.Filter",{ property:"order_.orderTime",value:this.getFromField().getValue(),expression:">="}))}else{ this.ordersStore.filters.removeAtKey("from")}if(this.getToField().getValue()){ var e=new Date(this.getToField().getValue().getTime()+24*60*60*1e3);this.ordersStore.filters.add("to",Ext.create("Ext.util.Filter",{ property:"order_.orderTime",value:e,expression:"<"}))}else{ this.ordersStore.filters.removeAtKey("to")}this.ordersStore.loadPage(1)},articleChanged:function(e){ this.down("viison_common_variant_combo_box-combo_box").setArticle(e)}});
