Ext.define("Shopware.apps.ViisonPickwareERPStockOverview.store.Sales",{ extend:"Ext.data.Store",storeId:"viison_pickware_erp_stock_overview-salesStore",autoLoad:false,model:"Shopware.apps.ViisonPickwareERPStockOverview.model.Sales",proxy:{ type:"ajax",api:{ read:'{url controller="ViisonPickwareERPStockOverview" action="salesByDay"}'},reader:{ type:"json",root:"data"}},listeners:{ load:{ fn:function(e,t){ e.addDataPadding(e,t);e.removeFirstYear();e.updateInterval()}}},firstYear:[],secondYear:[],planningFrom:new Date,planningTo:new Date,highestValueInStore:0,updateInterval:function(){ var e=1e3*60*60*24;var t=this.planningTo.getTime()-this.planningFrom.getTime();var a=Math.round(t/e);this.addFirstYear();this.setSlidingWindowSum("sales","salesAverage",Math.max(1,a));this.removeFirstYear()},updateRange:function(){ this.updateInterval();this.data.each(function(e){ this.setHightlightMarkerIfRequired(e.get("date"),e)},this)},setSlidingWindowSum:function(e,t,a){ var i=0;for(var r=0;r<this.data.length;r+=1){ var n=this.data.get(r);i+=n.get(e);if(r>=a){ var s=this.data.get(r-a);i-=s.get(e)}n.set(t,i)}},addDataPadding:function(e,t){ this.highestValueInStore=Math.max.apply(null,Ext.Array.map(t,function(e){ return Math.max(e.get("sales"),e.get("stock"))}));var a={ };for(var i=0;i<t.length;i+=1){ var r=Ext.Date.format(t[i].get("date"),"Y-m-d");a[r]=t[i];e.remove(t[i])}var n=new Date(Ext.Date.format(new Date,"Y-m-d"));var s=Ext.Date.add(n,Ext.Date.YEAR,-1);var d=s;var o=0;var h=0;while(d<n){ var l=Ext.Date.format(d,"Y-m-d");var g=a[l];if(typeof g!=="undefined"){ o=g.get("stock");h=g.get("sales")}else{ h=0}var v=e.model.create({ date:new Date(l),sales:h,stock:o,salesAverage:0,highlightFilterRangeHack:0});this.setHightlightMarkerIfRequired(d,v);e.add(v);d=Ext.Date.add(d,Ext.Date.DAY,1)}},setHightlightMarkerIfRequired:function(e,t){ if(e<=this.planningTo&&e>this.planningFrom){ t.set("highlightFilterRangeHack",this.highestValueInStore*1.1)}else{ t.set("highlightFilterRangeHack",0)}},removeFirstYear:function(){ var e=new Date-1e3*365*24*60*60;this.firstYear=Ext.Array.filter(this.data.items,function(t){ return t.get("date")<e});this.secondYear=Ext.Array.filter(this.data.items,function(t){ return t.get("date")>=e});this.removeAll();this.add(this.secondYear)},addFirstYear:function(){ this.removeAll();this.add(this.firstYear.concat(this.secondYear))}});
