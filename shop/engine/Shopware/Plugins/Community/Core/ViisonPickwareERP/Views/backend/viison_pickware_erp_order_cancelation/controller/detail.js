// {namespace name=backend/viison_pickware_erp_order_cancelation/main}
Ext.define("Shopware.apps.ViisonPickwareERPOrderCancelation.controller.Detail",{ override:"Shopware.apps.Order.controller.Detail",init:function(){ this.callParent(arguments);this.control({ "viison_pickware_erp_order_cancelation-detail-position-canceled_position_grid":{ canceledQuantityChanged:this.onCanceledQuantityChanged},"order-position-panel":{ cancelPositions:this.onCancelPositions}})},onCanceledQuantityChanged:function(e,i,a,t){ var l=typeof i.modified.viisonCanceledQuantity!=="undefined"?i.modified.viisonCanceledQuantity:i.get("viisonCanceledQuantity");if(l<=a){ i.set("viisonCanceledQuantity",t);return}var d=e.up("order-detail-window");var n=d.record;d.setLoading(true);Ext.Ajax.request({ method:"POST",url:'{url controller=ViisonPickwareERPOrderCancelation action=revertCanceledPosition}',jsonData:{ orderDetailId:i.get("id"),canceledQuantity:a},success:function(e){ var i=Ext.decode(e.responseText,true);if(i&&i.success){ ViisonPickwareERPOrderCancelationWindow.updateDetailWindow(d);var a='{s name=notification/revert_canceled_position/success/title}{/s}';var t=Ext.String.format('{s name=notification/revert_canceled_position/success/message}{/s}',n.get("number"));Shopware.Msg.createGrowlMessage(a,t,"Pickware")}else{ var l='{s name=notification/revert_canceled_position/failure/title}{/s}';var o='{s name=notification/revert_canceled_position/failure/message}{/s}';Shopware.Msg.createGrowlMessage(l,o,"Pickware")}}})},onCancelPositions:function(e){ var i=[];Ext.each(e.orderPositionGrid.getSelectionModel().getSelection(),function(e){ if(e.get("quantity")>0){ i.push({ orderDetailId:e.get("id"),articleNumber:e.get("articleNumber"),articleName:e.get("articleName"),price:-1*e.get("price"),taxId:e.get("taxId"),taxRate:e.get("taxRate"),quantity:e.get("quantity"),canceledQuantity:e.get("quantity"),shippedQuantity:e.get("shipped"),availableChange:Ext.max([e.get("quantity")-e.get("shipped"),0])})}});this.getView("Shopware.apps.ViisonPickwareERPOrderCancelationWindow.view.Window").create({ order:e.up("order-detail-window").record,taxStore:e.up("order-detail-window").subApplication.getStore("Tax"),positionsData:i,callback:this.cancelPositions.bind(this)}).show()},cancelPositions:function(e){ var i=e.order;var a=[];e.store.each(function(e){ if(!e.get("dummy")&&e.get("canceledQuantity")>0){ a.push({ id:e.get("orderDetailId"),quantity:e.get("canceledQuantity"),availableChange:e.get("availableChange")})}else if(e.get("quantity")){ a.push({ name:e.get("articleName"),quantity:e.get("quantity"),price:-1*e.get("price"),taxId:e.get("taxId")})}});var t=e.down("form[name=viison_pickware_erp_order_cancelation_window-form]").getForm().getValues();t.documentType=Ext.isNumber(t.documentType)?t.documentType:0;t.orderId=i.get("id");t.canceledItems=a;e.setLoading(true);Ext.Ajax.request({ method:"POST",url:'{url controller=ViisonPickwareERPOrderCancelation action=cancelPositions}',jsonData:t,scope:this,callback:function(a,t,l){ e.setLoading(false);var d=Ext.decode(l.responseText,true);if(d&&d.success){ e.close();ViisonPickwareERPOrderCancelationWindow.updateDetailWindow(this.getDetailWindow());var n='{s name=notification/cancel_positions/success/title}{/s}';var o=Ext.String.format('{s name=notification/cancel_positions/success/message}{/s}',i.get("number"));Shopware.Msg.createGrowlMessage(n,o,"Pickware")}else{ var c='{s name=notification/cancel_positions/failure/title}{/s}';var r='{s name=notification/cancel_positions/failure/message}{/s}';Shopware.Msg.createGrowlMessage(c,r,"Pickware")}}})}});
