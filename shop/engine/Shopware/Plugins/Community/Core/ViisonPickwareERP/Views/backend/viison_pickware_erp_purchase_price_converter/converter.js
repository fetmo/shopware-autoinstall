// {namespace name=backend/viison_pickware_erp_purchase_price_converter/main}
Ext.define("Shopware.apps.ViisonPickwareERPPurchasePriceConverter.Converter",{ singleton:true,alternateClassName:"ViisonPickwarePurchasePriceConverter",activePurchasePriceMode:'{$ViisonPickwareERPPurchasePriceConverter.purchasePriceModes.active}',configuredPurchasePriceMode:'{$ViisonPickwareERPPurchasePriceConverter.purchasePriceModes.configured}',modeChangeGrowlNotification:null,observeFormStore:function(i){ i.on("load",function(i,e){ if(e.length===0||e[0].get("name")!=="ViisonPickwareERP"){ return}this.configuredPurchasePriceMode=this.getPurchasePriceMode(e[0])},this);i.on("update",function(i,e,c){ if(e.get("name")!=="ViisonPickwareERP"||c!==Ext.data.Model.COMMIT){ return}this.configuredPurchasePriceMode=this.getPurchasePriceMode(e);this.updatePurchasePriceModeChangeNotification()},this)},checkPurchasePriceModeConfiguration:function(){ Ext.Ajax.request({ method:"GET",url:'{url controller=ViisonPickwareERPPurchasePriceConverter action=getPurchasePriceModes}',scope:this,success:function(i){ var e=Ext.JSON.decode(i.responseText,true);if(!e||!e.purchasePriceModes){ return}this.activePurchasePriceMode=e.purchasePriceModes.active||this.activePurchasePriceMode;this.configuredPurchasePriceMode=e.purchasePriceModes.configured||this.configuredPurchasePriceMode;this.updatePurchasePriceModeChangeNotification()}})},updatePurchasePriceModeChangeNotification:function(){ if(this.modeChangeGrowlNotification){ Shopware.Notification.closeGrowlMessage(this.modeChangeGrowlNotification,Shopware.Notification);this.modeChangeGrowlNotification=null}var i=this.activePurchasePriceMode;var e=this.configuredPurchasePriceMode;if(i===e){ return}this.modeChangeGrowlNotification=Shopware.Notification.createStickyGrowlMessage({ title:'{s name=notifications/purchase_price_mode_changed/title}{/s}',text:Ext.String.format('{s name=notifications/purchase_price_mode_changed/message}{/s}',ViisonPickwarePurchasePriceHelper.snippets[i],ViisonPickwarePurchasePriceHelper.snippets[e]),log:true,btnDetail:{ text:'{s name=notifications/purchase_price_mode_changed/buttons/convert}{/s}',scope:this,callback:function(){ this.onNotificationConvertPricesButton.apply(this,[i,e])}},onCloseButton:function(){ this.onNotificationCloseButton.apply(this,[i,e])}.bind(this),scope:this,callback:function(){ this.modeChangeGrowlNotification=null}},"ViisonPickwareERP")},onNotificationConvertPricesButton:function(i,e){ var c=Ext.String.format('{s name=alerts/convert_prices/message}{/s}',ViisonPickwarePurchasePriceHelper.snippets[i],ViisonPickwarePurchasePriceHelper.snippets[e]);Ext.Msg.confirm('{s name=alerts/convert_prices/title}{/s}',c,function(c){ if(c==="yes"){ Ext.Ajax.request({ method:"POST",url:'{url controller=ViisonPickwareERPPurchasePriceConverter action=convertPurchasePrices}',params:{ oldMode:i,newMode:e},scope:this,success:function(i){ var e=Ext.JSON.decode(i.responseText,true);var c=e&&e.success;if(e&&e.purchasePriceModes){ this.activePurchasePriceMode=e.purchasePriceModes.active||this.activePurchasePriceMode;this.configuredPurchasePriceMode=e.purchasePriceModes.configured||this.configuredPurchasePriceMode;this.updatePurchasePriceModeChangeNotification()}var o=c?'{s name=notifications/convert_prices/success/title}{/s}':'{s name=notifications/convert_prices/failure/title}{/s}';var s;if(c){ s='{s name=notifications/convert_prices/success/message}{/s}'}else{ s=e&&e.message?e.message:'{s name=notifications/convert_prices/failure/message}{/s}'}Shopware.Notification.createGrowlMessage(o,s,"ViisonPickwareERP",null,true)}})}else{ this.updatePurchasePriceModeChangeNotification()}},this)},onNotificationCloseButton:function(i,e){ Ext.Msg.show({ title:'{s name=alerts/close_change_notification/title}{/s}',msg:Ext.String.format('{s name=alerts/close_change_notification/message}{/s}',ViisonPickwarePurchasePriceHelper.snippets[i],ViisonPickwarePurchasePriceHelper.snippets[e]),buttons:Ext.Msg.OK,buttonText:{ cancel:'{s name=alerts/close_change_notification/buttons/hide_notification}{/s}'},icon:Ext.Msg.WARNING,scope:this,callback:function(i){ if(i!=="cancel"){ return}Ext.Ajax.request({ method:"POST",url:'{url controller=ViisonPickwareERPPurchasePriceConverter action=hideChangeNotification}',scope:this,success:function(i){ var e=Ext.JSON.decode(i.responseText,true);if(!e||!e.purchasePriceModes){ return}this.activePurchasePriceMode=e.purchasePriceModes.active||this.activePurchasePriceMode;this.configuredPurchasePriceMode=e.purchasePriceModes.configured||this.configuredPurchasePriceMode;this.updatePurchasePriceModeChangeNotification()}})}})},getPurchasePriceMode:function(i){ var e=i.getElements().findExact("name","purchasePriceMode");if(e===-1){ return null}var c=i.getElements().getAt(e);return c.getValues().count()>0?c.getValues().first().get("value"):c.get("value")}});
