// {namespace name=backend/viison_pickware_erp_article_supplier_assignment/main}
Ext.define("Shopware.apps.ViisonPickwareERPArticleSupplierAssignment.controller.Main",{ extend:"Ext.app.Controller",refs:[{ ref:"mainTabPanel",selector:"article-detail-window tabpanel"},{ ref:"cancelButton",selector:"article-detail-window button[name=cancel-button]"},{ ref:"saveButton",selector:"article-detail-window button[name=save-article-button]"},{ ref:"supplierAssignmentPanel",selector:"viison_pickware_erp_article_supplier_assignment-detail-supplier_assignment"},{ ref:"copyAssignmentButton",selector:"viison_pickware_erp_article_supplier_assignment-detail-supplier_assignment button[action=copyAssignmentToAllVariants]"}],init:function(){ this.control({ "viison_pickware_erp_article_supplier_assignment-detail-supplier_assignment":{ moveItemsFromLeftToRight:this.onMoveSuppliersFromLeftToRight,moveItemsFromLeftToRightViaDragDrop:this.onMoveSuppliersFromLeftToRight,moveItemsFromRightToLeft:this.onMoveSuppliersFromRightToLeft,moveItemsFromRightToLeftViaDragDrop:this.onMoveSuppliersFromRightToLeft,supplierRowEdited:this.onSupplierRowEdited,leftPanelSearchFieldChanged:this.onSearchFieldChanged,rightPanelSearchFieldChanged:this.onSearchFieldChanged,copyAssignmentToAllVariants:this.onCopyAssignmentToAllVariants},"viison_pickware_erp_article_supplier_assignment-detail-supplier_assignment viison_common_variant_combo_box-combo_box":{ variantChanged:this.onVariantChanged}});this.getMainTabPanel().on("tabchange",function(e,i){ var t=i.name==="viison_pickware_erp_article_supplier_assignment-tab";this.getCancelButton().setDisabled(t);this.getSaveButton().setDisabled(t)},this);this.leftStore=Ext.create("Shopware.apps.ViisonPickwareERPArticleSupplierAssignment.store.Supplier",{ autoLoad:false});this.rightStore=Ext.create("Shopware.apps.ViisonPickwareERPArticleSupplierAssignment.store.AssignedSupplier",{ autoLoad:false});this.callParent(arguments)},createAssignmentTab:function(){ var e=Ext.create("Shopware.apps.ViisonPickwareERPArticleSupplierAssignment.view.detail.SupplierAssignment",{ leftStore:this.leftStore,rightStore:this.rightStore});this.subApplication.on("ProductModule:storesChanged",this.articleChanged,e);var i=e.down("viison_common_variant_combo_box-combo_box");i.setArticle(this.article);return e},onMoveSuppliersFromLeftToRight:function(e,i){ var t=e.down("viison_common_variant_combo_box-combo_box");var s=t.getSelectedVariant();Ext.each(i,function(i){ i.set("articleDetailId",s?s.get("id"):null);i.set("purchasePrice",s?s.get("purchasePrice"):0);i.set("defaultSupplier",e.rightStore.count()===1);i.commit();i.phantom=true},this);this.updateCopyAssignmentButton();this.syncAssignedSuppliers('{s name=notification/error/message/add}{/s}',function(){ e.leftStore.loadPage(e.leftStore.currentPage);e.rightStore.loadPage(e.rightStore.currentPage)})},onMoveSuppliersFromRightToLeft:function(e){ this.updateCopyAssignmentButton();this.syncAssignedSuppliers('{s name=notification/error/message/delete}{/s}',function(){ e.leftStore.loadPage(e.leftStore.currentPage);e.rightStore.loadPage(e.rightStore.currentPage)})},onSupplierRowEdited:function(e,i){ if(i.get("defaultSupplier")){ e.rightStore.each(function(e){ if(e.get("id")!==i.get("id")){ e.set("defaultSupplier",false)}})}i.setDirty();this.syncAssignedSuppliers('{s name=notification/error/message/update}{/s}')},onSearchFieldChanged:function(e,i){ i.getProxy().extraParams.query=e;i.loadPage(1)},onVariantChanged:function(e){ if(e){ this.loadAssignedSuppliers(e)}else{ this.leftStore.clearFilter(true);this.rightStore.clearFilter(true);this.leftStore.removeAll();this.rightStore.removeAll()}},onCopyAssignmentToAllVariants:function(e){ Ext.Msg.confirm('{s name=alert/title}{/s}','{s name=alert/message/copy_assignments}{/s}',function(i){ if(i!=="yes"){ return}var t=e.down("viison_common_variant_combo_box-combo_box");var s=t.getSelectedVariant();this.getSupplierAssignmentPanel().setLoading(true);Ext.Ajax.request({ url:'{url controller=ViisonPickwareERPArticleSupplierAssignment action=transferSupplierArticleDetails}',params:{ articleDetailId:s?s.get("id"):null},callback:function(e,i){ this.getSupplierAssignmentPanel().setLoading(false);if(!i){ Shopware.Notification.createGrowlMessage('{s name=notification/error/title}{/s}','{s name=notification/error/message/copy_assignments}{/s}',"ViisonPickwareERPArticleSupplierAssignment")}},scope:this})},this)},setArticle:function(e){ this.article=e},loadAssignedSuppliers:function(e){ this.leftStore.filters.add("articleDetailBlacklist",Ext.create("Ext.util.Filter",{ property:"articleDetailIdBlacklist",expression:"!=",value:e.get("id")}));this.rightStore.filters.add("articleDetailId",Ext.create("Ext.util.Filter",{ property:"supplierArticleDetail.articleDetailId",value:e.get("id")}));this.leftStore.loadPage(1);this.rightStore.loadPage(1,{ callback:function(){ this.updateCopyAssignmentButton()},scope:this})},updateCopyAssignmentButton:function(){ var e=this.getSupplierAssignmentPanel().rightStore.count()===0;this.getCopyAssignmentButton().setDisabled(e)},syncAssignedSuppliers:function(e,i){ var t=this.rightStore.getNewRecords().length+this.rightStore.getModifiedRecords().length+this.rightStore.getRemovedRecords().length;if(t===0){ if(Ext.isFunction(i)){ i(true)}return}this.getSupplierAssignmentPanel().rightPanel.setLoading(true);this.rightStore.sync({ scope:this,success:function(){ this.getSupplierAssignmentPanel().rightPanel.setLoading(false);if(Ext.isFunction(i)){ i(true)}},failure:function(){ this.getSupplierAssignmentPanel().rightPanel.setLoading(false);this.rightStore.rejectChanges();var t=e||"";Shopware.Notification.createGrowlMessage('{s name=notification/error/title}{/s}',t,"ViisonPickwareERPArticleSupplierAssignment");if(Ext.isFunction(i)){ i(false)}}})},articleChanged:function(e){ this.down("viison_common_variant_combo_box-combo_box").setArticle(e)}});
