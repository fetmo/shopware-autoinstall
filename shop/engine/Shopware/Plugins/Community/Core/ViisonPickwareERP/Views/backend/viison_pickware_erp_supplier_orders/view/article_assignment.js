// {namespace name=backend/viison_pickware_erp_supplier_orders/main}
Ext.define("Shopware.apps.ViisonPickwareERPSupplierOrders.view.ArticleAssignment",{ extend:"Shopware.apps.ViisonPickwareERPSupplierCommon.view.AssignmentPanel",alias:"widget.viison_pickware_erp_supplier_orders-article_assignment",border:false,supplierOrderDestinations:{ },initComponent:function(){ this.callParent(arguments);if(!this.record){ Ext.apply(this.items[1],{ layout:{ type:"vbox",pack:"start"}});this.rightPanel.on("groupclick",function(e,i,t,d){ var l=parseInt(t,10);var r=d.getTarget().getAttribute("data-action");if(r==="changeWarehouse"){ this.fireEvent("changeWarehouse",this,l)}else if(r==="createSingleOrder"){ var a;Ext.each(this.rightStore.getGroups(),function(e){ if(e.name===l){ a=e.children;return false}return undefined});this.fireEvent("createSingleOrder",this,a,l)}},this)}else{ this.rightPanel.nextSibling("form").loadRecord(this.record)}},getLeftPanelConfig:function(){ var e=this.callParent(arguments);var i=Ext.create("Shopware.apps.ViisonPickwareERPSupplierManagement.store.Supplier",{ pageSize:10});i.load();e.dockedItems[0].items.splice(2,0,{ xtype:"combobox",emptyText:'{s name=edit/article_assignment/supplier_selection/placeholder}{/s}',store:i,displayField:"name",valueField:"id",pageSize:10,typeAhead:false,autoSelect:false,width:170,matchFieldWidth:false,listConfig:{ width:220,getInnerTpl:function(e){ return'<tpl if="id == 0"><span style="color:#6c818f;"></tpl>{ '+e+'}<tpl if="id == 0"></span></tpl>'}},listeners:{ change:function(e,i,t){ if((Ext.isNumeric(i)||i===null)&&i!==t){ var d=Ext.isNumeric(i)?e.findRecord("id",i):null;this.fireEvent("supplierFilterChanged",d,this.leftStore)}},focus:function(e){ e.expand()},scope:this}},"->");return e},createLeftColumns:function(){ var e=this.createSharedArticleColumns();e.splice(0,0,{ header:"",dataIndex:"reorder",width:30,renderer:function(e,i,t){ i.style="padding: 0;";if(e===2){ i.tdAttr='data-qtip="{s name=edit/article_assignment/tooltip/urgent_reorder}{/s}"';return'<img alt="" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" class="sprite-exclamation-red">'}else if(e===1){ i.tdAttr='data-qtip="{s name=edit/article_assignment/tooltip/reorder}{/s}"';return'<img alt="" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" class="sprite-exclamation">'}else if(t.get("dropShippingArticle")){ i.tdAttr='data-qtip="{s name=edit/article_assignment/tooltip/drop_shipping}{/s}"';return'<img alt="" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" class="sprite-box">'}return""}});e.splice(6,0,{ header:'{s name=edit/article_assignment/column/incoming_stock}{/s}',dataIndex:"incomingStock",flex:1});return e},createRightContainer:function(){ if(!this.record){ return this.callParent(arguments)}return{ xtype:"panel",flex:1,layout:"border",border:false,items:[this.rightPanel,{ xtype:"form",region:"south",record:this.record,height:200,layout:{ type:"hbox",align:"stretch"},items:[{ xtype:"fieldset",title:'{s name=edit/article_assignment/field/document_comment/title}{/s}',flex:1,margin:5,padding:"5 3 5 5",items:[{ xtype:"textareafield",name:"documentComment",height:120,anchor:"100%",supportText:'{s name=edit/article_assignment/field/document_comment/info}{/s}'}]},{ xtype:"fieldset",title:'{s name=edit/article_assignment/field/comment/title}{/s}',flex:1,margin:5,padding:"5 3 5 5",items:[{ xtype:"textareafield",name:"comment",height:120,anchor:"100%",supportText:'{s name=edit/article_assignment/field/comment/info}{/s}'}]}]}],dockedItems:[{ xtype:"toolbar",dock:"bottom",ui:"shopware-ui",items:["->",{ text:'{s name=edit/article_assignment/toolbar/button/cancel}{/s}',cls:"secondary",action:"cancelEditing",handler:function(){ this.fireEvent("cancelEditing",this)},scope:this},{ text:'{s name=edit/article_assignment/toolbar/button/copy}{/s}',cls:"secondary",action:"copyOrder",disabled:this.record.getSupplier()===null,handler:function(){ this.fireEvent("copyOrder",this)},scope:this},{ text:'{s name=edit/article_assignment/toolbar/button/save}{/s}',cls:"primary",action:"saveOrder",handler:function(){ this.fireEvent("saveOrder",this)},scope:this}]}]}},getRightPanelConfig:function(){ var e=this.callParent(arguments);e.cls="x-tabpanel-child";e.region="center";e.dockedItems=[];Ext.apply(e.viewConfig,{ preserveScrollOnRefresh:true});this.rowEditor=Ext.create("Ext.grid.plugin.RowEditing",{ clicksToMoveEditor:1,autoCancel:false,listeners:{ scope:this,edit:function(e,i){ i.record.set("price",i.newValues.price);i.record.commit();this.fireEvent("articleRowEdited",this,i.record)}}});e.plugins=e.plugins||[];e.plugins.push(this.rowEditor);this.rightPanelGroupingFeature=Ext.create("Shopware.apps.ViisonPickwareERPSupplierOrders.ux.GridFeatureGrouping",{ hideGroupedHeader:false,enableGroupingMenu:false,collapsible:false,groupHeaderTpl:['<div style="float: left;">',"{literal}{ groupValue:this.formatSupplier} ({ groupValue:this.formatOrderValue}){/literal}","</div>",'<div style="float: left; margin-left: 5px; display: {literal}{ groupValue:this.selectDisplayMode}{/literal};">','{s name=edit/article_assignment/grouping/header/destination_warehouse_prefix}{/s} {literal}{ groupValue:this.formatSelectedWarehouse}{/literal}',"</div>",'<div class="sprite-pencil" style="float: left; margin-left: 5px; margin-top: -3px; display: {literal}{ groupValue:this.selectDisplayMode}{/literal};" data-qtip="{s name=edit/article_assignment/grouping/header/change_warehouse_button/tooltip}{/s}" data-action="changeWarehouse"></div>','<div style="position: relative; float: right; margin-top: -7px; display: {literal}{ groupValue:this.selectDisplayMode}{/literal};">','<div class="x-btn primary small x-toolbar-item x-btn-default-toolbar-small x-noicon x-btn-noicon x-btn-default-toolbar-small-noicon">',"<em>",'<button class="x-btn-center" hidefocus="true" role="button" data-action="createSingleOrder">','<span class="x-btn-inner" data-action="createSingleOrder">{s name=edit/article_assignment/grouping/header/create_order_button}{/s}</span>',"</button>","</em>","</div>","</div>",{ formatSupplier:function(e){ var i=this.supplierStore.getById(e);return i?i.get("name"):'{s name=edit/article_assignment/no_supplier}{/s}'}.bind(this),formatOrderValue:function(e){ var i=this.rightStore.queryBy(function(i){ return i.data.supplierId===e});var t=0;i.each(function(e){ t+=e.data.price*e.data.orderedQuantity});return Ext.String.format('{s name=edit/article_assignment/supplier_order_info_header}{/s}',i.length,ViisonCurrencyFormatter.renderer(t))}.bind(this),formatSelectedWarehouse:function(e){ if(!e){ return""}var i;var t;if(this.supplierOrderDestinations[e]){ t=this.warehouseStore.findExact("id",this.supplierOrderDestinations[e]);i=this.warehouseStore.getAt(t)}else{ t=this.warehouseStore.findExact("defaultWarehouse",true);i=this.warehouseStore.getAt(t);this.supplierOrderDestinations[e]=i.get("id")}return i.get("displayName")}.bind(this),selectDisplayMode:function(e){ return e&&!this.record?"block":"none"}.bind(this)}]});e.features=e.features||[];e.features.push(this.rightPanelGroupingFeature);if(!this.record){ e.dockedItems=[{ xtype:"toolbar",dock:"bottom",items:[{ tooltip:'{s name=edit/article_assignment/toolbar/button/reload}{/s}',iconCls:"sprite-arrow-circle-135",action:"reloadRightPanel",scope:this,handler:function(){ this.fireEvent("reloadRightPanel",this)}},"->",{ text:'{s name=edit/article_assignment/toolbar/button/create_all_orders}{/s}',cls:"primary",action:"createAllOrders",scope:this,handler:function(){ this.fireEvent("createAllOrders",this)}}]}]}else{ e.dockedItems=[{ xtype:"toolbar",dock:"top",items:[{ xtype:"viison_pickware_erp_warehouse_management-warehouse_combo_box",name:"warehouseSelection",initialValue:this.record.get("warehouseId"),allowBlank:false,fieldLabel:'{s name=edit/article_assignment/toolbar/destination_warehouse_selection/label}{/s}'}]}]}return e},createRightColumns:function(){ var e=this.createSharedArticleColumns();Ext.each([0,1,3],function(i){ e[i].editor={ xtype:"textfield",readOnly:true}});e.splice(6,0,{ header:'{s name=edit/article_assignment/column/order_quantity}{/s}',dataIndex:"orderedQuantity",width:45,align:"right",editor:{ xtype:"numberfield",allowBlank:false,minValue:1,step:1}},{ header:ViisonPickwarePurchasePriceHelper.purchasePriceLabel('{s name=edit/article_assignment/column/price}{/s}'),dataIndex:"price",width:60,align:"right",editor:{ xtype:"numberfield",allowBlank:true,minValue:0,step:.01},renderer:ViisonCurrencyFormatter.renderer});var i=e[e.length-1];i.width+=25;i.items.push({ iconCls:"sprite-minus-circle",action:"removeArticleDetail",tooltip:'{s name=edit/article_assignment/tooltip/remove_item}{/s}',scope:this,handler:function(e,i){ this.fireEvent("removeArticleDetail",this,e.getStore().getAt(i))}});if(!this.record){ var t={ header:'{s name=edit/article_assignment/column/supplier}{/s}',dataIndex:"supplierId",flex:1,scope:this,renderer:function(e,i,t){ var d=this.supplierStore.getById(t.get("supplierId"));return d?d.get("name"):'{s name=edit/article_assignment/no_supplier}{/s}'}};e.splice(4,0,t);var d=Ext.create("Shopware.apps.ViisonPickwareERPSupplierManagement.store.Supplier",{ pageSize:10});d.on("load",function(){ this.supplierStore.load()},this);d.load();t.editor={ xtype:"combo",store:d,displayField:"name",valueField:"id",pageSize:10,typeAhead:false,autoSelect:false,editable:false,emptyText:'{s name=edit/article_assignment/no_supplier}{/s}',matchFieldWidth:false,listConfig:{ width:220},listeners:{ scope:this,select:function(e,i){ var t=this.rightPanel.getSelectionModel().getSelection();if(i.length>0&&t.length>0){ var d=this.rowEditor.editor.getForm();var l=d.getValues();var r=t[0];var a=i[0].get("id");if(r.isSupplierIdAssigned(a)){ var s=r.getSupplierDataForSupplierId(a);l.orderedQuantity=s.orderAmount;l.price=s.purchasePrice;l.supplierArticleNumber=s.supplierArticleNumber}l.orderedQuantity=Math.max(1,l.orderedQuantity,r.getMissingStock());this.rowEditor.editor.getForm().setValues(l)}}}}}if(this.record){ e.splice(6,0,{ header:'{s name=edit/article_assignment/column/delivered_quantity}{/s}',dataIndex:"deliveredQuantity",width:45,align:"right",editor:{ xtype:"numberfield",allowBlank:true,minValue:0,step:1}});e.splice(e.length-1,0,{ header:'{s name=edit/article_assignment/column/status}{/s}',dataIndex:"status",width:55,editor:{ xtype:"combobox",store:this.itemStatusStore,queryMode:"local",valueField:"id",displayField:"description",editable:false,triggerAction:"all",selectOnTab:true,lazyRender:true,listClass:"x-combo-list-small"},scope:this,renderer:function(e){ var i=this.itemStatusStore.getById(e);return i?i.get("description"):e}})}e.splice(4,0,{ header:'{s name=edit/article_assignment/column/supplier_article_number}{/s}',dataIndex:"supplierArticleNumber",flex:2,editor:{ xtype:"textfield",readOnly:true}});return e},createMiddleContainer:function(){ if(this.record){ return this.callParent(arguments)}return{ xtype:"panel",border:1,layout:{ type:"vbox",pack:"center"},bodyStyle:{ backgroundColor:"#ebedef"},items:[{ xtype:"panel",border:0,margin:"48 0 0 0",layout:{ type:"vbox",pack:"top"},bodyStyle:{ backgroundColor:"#ebedef"},items:[{ xtype:"button",cls:Ext.baseCSSPrefix+"form-itemselector-btn",iconCls:"c-sprite-add-urgent-reorder-articles",tooltip:'{s name=edit/article_assignment/tooltip/assign_urgent_reorder_articles}{/s}',navBtn:true,margin:"4 4 2 4",scope:this,handler:function(){ this.fireEvent("assignUrgentReorderArticles",this)}},{ xtype:"button",cls:Ext.baseCSSPrefix+"form-itemselector-btn",iconCls:"c-sprite-add-reorder-articles",tooltip:'{s name=edit/article_assignment/tooltip/assign_reorder_articles}{/s}',navBtn:true,margin:"2 4 4 4",scope:this,handler:function(){ this.fireEvent("assignReorderArticles",this)}}]},{ xtype:"panel",border:0,flex:1,layout:{ type:"vbox",pack:"center"},bodyStyle:{ backgroundColor:"#ebedef"},items:this.createMiddleButtons()}]}},createSharedArticleColumns:function(){ return[{ header:'{s name=edit/article_assignment/column/name}{/s}',dataIndex:"name",flex:3},{ header:'{s name=edit/article_assignment/column/order_number}{/s}',dataIndex:"orderNumber",flex:2},{ header:'{s name=edit/article_assignment/column/fabricator_name}{/s}',dataIndex:"fabricatorName",flex:3},{ header:'{s name=edit/article_assignment/column/fabricator_number}{/s}',dataIndex:"fabricatorNumber",flex:2},{ header:'{s name=edit/article_assignment/column/available}{/s}',dataIndex:"available",flex:1},{ header:'{s name=edit/article_assignment/column/stock_min}{/s}',dataIndex:"stockMin",flex:1},{ xtype:"actioncolumn",width:25,items:[{ iconCls:"sprite-sticky-notes-pin",action:"showArticleDetail",tooltip:'{s name=edit/article_assignment/tooltip/show_article_details}{/s}',scope:this,getClass:function(e,i,t){ return!t.get("articleId")?"x-hide-visibility":""},handler:function(e,i){ this.fireEvent("showArticleDetail",e.getStore().getAt(i))}}]}]}});
