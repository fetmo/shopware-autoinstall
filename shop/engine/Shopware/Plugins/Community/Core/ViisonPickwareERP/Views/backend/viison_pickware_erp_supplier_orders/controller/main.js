// {namespace name=backend/viison_pickware_erp_supplier_orders/main}
Ext.define("Shopware.apps.ViisonPickwareERPSupplierOrders.controller.Main",{ extend:"Ext.app.Controller",mainWindow:null,refs:[{ ref:"listView",selector:"viison_pickware_erp_supplier_orders-main-list"}],init:function(){ this.control({ "viison_pickware_erp_supplier_orders-main-list button[action=addOrder]":{ click:this.onAddOrder},"viison_pickware_erp_supplier_orders-main-list":{ saveOrder:this.onSaveOrder,editOrder:this.onEditOrder,deleteOrder:this.onDeleteOrder,sendOrderMail:this.onSendOrderMail,downloadOrderPDF:this.onDownloadOrderPDF,downloadOrderCSV:this.onDownloadOrderCSV,searchFieldChanged:this.onSearchFieldChanged},"viison_pickware_erp_supplier_orders-main-list viison_pickware_erp_warehouse_management-warehouse_combo_box":{ warehouseChanged:this.onWarehouseChanged},"viison_common_mail_composer-window viison_common_mail_composer-main":{ sendMail:this.onSendMail}});this.orderStore=Ext.create("Shopware.apps.ViisonPickwareERPSupplierOrders.store.Order",{ });this.warehouseStore=Ext.create("Shopware.apps.ViisonPickwareERPWarehouseManagement.store.Warehouse",{ });this.warehouseStore.load();if(this.subApplication&&this.subApplication.params&&Ext.isNumeric(this.subApplication.params.orderId)){ this.orderStore.filters.add("singleOrder",Ext.create("Ext.util.Filter",{ property:"supplierOrder.id",value:this.subApplication.params.orderId}));this.orderStore.load({ scope:this,callback:function(i){ this.orderStore.filters.removeAtKey("singleOrder");if(i.length===1){ this.onEditOrder(i[0])}else{ Shopware.Notification.createGrowlMessage('{s name=notification/error/title}{/s}',Ext.String.format('{s name=notification/error/message/order_not_found}{/s}',this.subApplication.params.orderId),"ViisonPickwareERPSupplierOrders")}}})}else{ this.mainView=this.getView("Main").create({ orderStore:this.orderStore,warehouseStore:this.warehouseStore,orderStatusStore:this.getStore("order.Status"),paymentStatusStore:this.getStore("order.PaymentStatus")})}this.getStore("order.Status").on("load",this.onOrderStatusStoreLoad,this);this.callParent(arguments)},onAddOrder:function(){ this.getController("Edit").createEditWindow()},onSaveOrder:function(i,e){ if(e.status!==4&&i.get("status")===4){ i.set("deliveryDate",new Date);Ext.Msg.confirm('{s name=alert/title}{/s}','{s name=alert/message/mark_items_as_completely_received}{/s}',function(e){ if(e==="yes"){ i.articles().each(function(i){ if(i.get("status")<4){ i.set("status",4);i.set("deliveredQuantity",i.get("orderedQuantity"))}})}this.syncOrders('{s name=notification/error/message/save}{/s}')},this)}else{ this.syncOrders('{s name=notification/error/message/save}{/s}')}},onEditOrder:function(i){ this.getController("Edit").createEditWindow(i)},onDeleteOrder:function(i){ Ext.Msg.confirm('{s name=alert/title}{/s}','{s name=alert/message/delete}{/s}',function(e){ if(e!=="yes"){ return}this.orderStore.remove(i);this.syncOrders('{s name=notification/error/message/delete}{/s}')},this)},onSendOrderMail:function(i){ this.setMainViewLoading(true);Ext.Ajax.request({ url:'{url controller=ViisonPickwareERPSupplierOrders action=getOrderMail}',params:{ orderId:i.get("id")},success:function(e){ this.setMainViewLoading(false);var r=Ext.JSON.decode(e.responseText,true);if(!r||!r.data){ Shopware.Notification.createGrowlMessage('{s name=notification/error/title}{/s}','{s name=notification/error/message/create_mail}{/s}',"ViisonPickwareERPSupplierOrders");return}Ext.create("Shopware.apps.ViisonCommonMailComposer.view.Window",{ subApp:this.subApplication,mail:r.data,orderController:this,orderRecord:i}).show()},failure:function(){ this.setMainViewLoading(false);Shopware.Notification.createGrowlMessage('{s name=notification/error/title}{/s}','{s name=notification/error/message/create_mail}{/s}',"ViisonPickwareERPSupplierOrders")},scope:this})},onDownloadOrderPDF:function(i){ var e='{url controller=ViisonPickwareERPSupplierOrders action=downloadOrderPDF}?orderId='+i.get("id");window.open(e,"_blank")},onDownloadOrderCSV:function(i){ var e='{url controller=ViisonPickwareERPSupplierOrders action=downloadOrderCSV}?orderId='+i.get("id");window.open(e,"_blank")},onSearchFieldChanged:function(i){ this.orderStore.getProxy().extraParams.query=i;this.orderStore.loadPage(1)},onWarehouseChanged:function(i){ this.orderStore.clearFilter(true);if(i){ this.orderStore.filter([{ property:"supplierOrder.warehouseId",value:i.get("id")}])}else{ this.orderStore.load()}},onOrderStatusStoreLoad:function(){ if(this.getListView()){ this.getListView().reconfigure(this.orderStore)}},onSendMail:function(i){ if(!i.getForm().isValid()){ return}var e=i.getValues();var r=i.up("viison_common_mail_composer-window");var t=r.orderRecord;e.orderId=t.get("id");r.setLoading(true);Ext.Ajax.request({ url:'{url controller=ViisonPickwareERPSupplierOrders action=sendOrderMail}',params:e,success:function(i){ r.setLoading(false);r.close();var e=Ext.JSON.decode(i.responseText,true);if(e&&e.success===true&&e.data&&e.data.status){ t.set("status",e.data.status);t.commit()}},failure:function(){ r.setLoading(false);Shopware.Notification.createGrowlMessage('{s name=notification/error/title}{/s}','{s name=notification/error/message/send_mail}{/s}',"ViisonPickwareERPSupplierOrders")}})},syncOrders:function(i,e){ var r=this.orderStore.getNewRecords().length+this.orderStore.getModifiedRecords().length+this.orderStore.getRemovedRecords().length;if(r===0){ if(Ext.isFunction(e)){ e(true)}return}this.setMainViewLoading(true);this.orderStore.sync({ scope:this,success:function(i){ this.setMainViewLoading(false);if(Ext.isFunction(e)){ var r=[];if(i.operations){ var t;Ext.each(i.operations,function(i){ if(i.action==="create"){ t=i;return false}return undefined});if(t&&t.resultSet&&t.resultSet.records){ r=t.resultSet.records}}e(true,r)}},failure:function(){ this.setMainViewLoading(false);this.orderStore.rejectChanges();var r=i||"";Shopware.Notification.createGrowlMessage('{s name=notification/error/title}{/s}',r,"ViisonPickwareERPSupplierOrders");if(Ext.isFunction(e)){ e(false)}}})},setMainViewLoading:function(i){ if(this.mainView){ this.mainView.setLoading(i)}}});
